@using System.Web.Optimization
@model POC.Models.Discussion

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sentient Clinical System (Mock Up) Chat</title>
        @Styles.Render("~/Content/css")
        @Scripts.Render("~/bundles/jquery")
        @Scripts.Render("~/bundles/bootstrap")
        @Scripts.Render("~/bundles/common")
        <script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
        <script src="~/signalr/hubs"></script>
    </head>
    <body>
        <div class="body-content-chat">
            @Html.HiddenFor(a => Model.RoomId)
            @Html.HiddenFor(a => Model.Users)
            @Html.HiddenFor(a => Model.LoggedInUser)
            <div>
                @foreach (var user in Model.Users)
                {
                    @Html.Label(user.Description, new {@class = "control-label"})
                    <span>&nbsp;</span>
                }
                @Html.Label(Model.UserWhoStartedChat, new { @class = "control-label" })
            </div>
            <hr/>
            <div style="height: 400px; overflow-y: scroll;">
                <ul id="discussion"></ul>
            </div>
            <div>
                @Html.TextArea("message", new { @class = "form-control" })
                <input type="button" id="send" class="btn btn-primary" value="Send"/>
            </div>
        </div>
    </body>
</html>
<script type="text/javascript">
    //function disableF5(e) {
    //     if ((e.which || e.keyCode) === 116 || (e.which || e.keyCode) === 82) {
    //         e.preventDefault();
    //     }
    //};
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }

    $(document).ready(function () {
        //$(document).on("keydown", disableF5);

        if (history.pushState) {
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({ path: newurl }, '', newurl);
        }

        var username = "@Model.LoggedInUser";
        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.Chat;

        chat.client.addMessageToRoom = function (name, message, roomId, dateSent) {
            // Add the message to the page.
            $("#discussion").append("<li class='chat-datetime-li'><div><strong>" + htmlEncode(name) + "</strong>: <span class='chat-datetime'>" + htmlEncode(dateSent) + "</span></div>"
                + "</li><li class='chat-message-li'><div class='chat-message'>" + htmlEncode(message) + "</div></li>");

            var height = 0;
            $('li div').each(function (i, value) {
                height += parseInt($(this).height());
            });
            height += 10 + '';
            $('div').animate({ scrollTop: height });
        };
        $("#message").focus();

        // Start the connection.
        $.connection.hub.start().done(function () {
            chat.server.joinRoom(username, "@Model.RoomId");

            if ("@Model.LoggedInUser" === "@Model.UserWhoStartedChat") {
                // broadcast to everybody to start their chat and open their windows
                chat.server.startChat("@Model.UserList", "@Model.RoomId");
            };

            $("#message").keyup(function (e) {
                var code = e.keyCode ? e.keyCode : e.which;
                if (code === 13) {  // Enter keycode
                    $("#send").click();
                }
            });

            $('#send').click(function () {
                var message = $("#message").val().trim();
                if (message === "") {
                    $("#message").focus();
                    return;
                }
                chat.server.sendToRoom("@Model.RoomId", username, message);
                $("#message").val("").focus();
            });

        });
    });
</script>
