@using System.Web.Optimization
@model POC.Models.Discussion

@Styles.Render("~/Content/css")
@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/bootstrap")
@Scripts.Render("~/bundles/common")

<!--Script references. -->
<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
<!--Reference the autogenerated SignalR hub script. *REFERENCE TO PROXY FILE* -->
<script src="~/signalr/hubs"></script>
<!--SignalR script to update the chat page and send messages.-->
    <div>
        @Html.HiddenFor(a => Model.RoomId)
        <div>
            @foreach(var user in Model.Users)
            {
                @Html.Label(user.Description)
            }
        </div>
        <div>
            <ul id="discussion" />
        </div>
        <div>
            @Html.TextArea("message")
            <input type="button" id="send" class="btn btn-primary" value="Send" />
        </div>

    </div>

<script type="text/javascript">
    $(document).ready(function () {
        var username = "@Model.LoggedInUser";
        //$("#SelectedUserIds").multiselect({ numberDisplayed: 1 });
        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.Chat;

        chat.client.addMessageToRoom = function(name, message, roomId) {
            // Add the message to the page.
            $('#discussion').append('<li><strong>' + htmlEncode(name)
                + '</strong>: ' + roomId + " " + htmlEncode(message) + '</li>');
        };

        // Get the user name and store it to prepend to messages.
        // Set initial focus to message input box.
        $('#message').focus();
        // Start the connection.
        $.connection.hub.start().done(function () {
            chat.server.joinRoom(username, "@Model.RoomId");

            if ("@Model.LoggedInUser" === "@Model.UserWhoStartedChat") {
                // broadcast to everybody to start their chat and open their windows
               chat.server.startChat("Joey;David;Alex", "@Model.RoomId");
            };

            $('#send').click(function() {
                // Call the Send method on the hub.
                chat.server.sendToRoom("@Model.RoomId", username, $('#message').val());
                // Clear text box and reset focus Joeyfor next comment.
                $('#message').val('').focus();
            });

        });
    });

    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }

</script>